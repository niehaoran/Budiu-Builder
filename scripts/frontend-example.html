<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>应用构建系统</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .card {
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2980b9;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .hidden {
      display: none;
    }

    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table,
    th,
    td {
      border: 1px solid #ddd;
    }

    th,
    td {
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }
  </style>
</head>

<body>
  <h1>Budiu-Builder</h1>

  <div class="card">
    <h2>提交构建</h2>
    <form id="buildForm">
      <div class="form-group">
        <label for="repoUrl">代码仓库 URL:</label>
        <input type="text" id="repoUrl" placeholder="例如: https://github.com/username/repo" required>
      </div>

      <div class="form-group">
        <label for="branch">分支:</label>
        <input type="text" id="branch" value="main">
      </div>

      <div class="form-group">
        <label for="imageName">镜像名称:</label>
        <input type="text" id="imageName" placeholder="例如: myusername/myapp" required>
      </div>

      <div class="form-group">
        <label for="imageTag">镜像标签:</label>
        <input type="text" id="imageTag" value="latest">
      </div>

      <div class="form-group">
        <label for="registry">镜像仓库地址:</label>
        <input type="text" id="registry" value="docker.io">
      </div>

      <button type="submit">提交构建请求</button>
    </form>
  </div>

  <div id="statusCard" class="card hidden">
    <h2>构建状态</h2>
    <div id="statusOutput" class="status"></div>

    <div id="buildDetails" class="hidden">
      <h3>构建详情</h3>
      <table>
        <tr>
          <th>构建 ID</th>
          <td id="buildId"></td>
        </tr>
        <tr>
          <th>状态</th>
          <td id="buildStatus"></td>
        </tr>
        <tr>
          <th>创建时间</th>
          <td id="createdAt"></td>
        </tr>
        <tr>
          <th>更新时间</th>
          <td id="updatedAt"></td>
        </tr>
        <tr id="imageRow" class="hidden">
          <th>镜像</th>
          <td id="imageUrl"></td>
        </tr>
      </table>

      <button id="refreshStatus" style="margin-top: 15px;">刷新状态</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const buildForm = document.getElementById('buildForm');
      const statusCard = document.getElementById('statusCard');
      const statusOutput = document.getElementById('statusOutput');
      const buildDetails = document.getElementById('buildDetails');
      const buildIdDisplay = document.getElementById('buildId');
      const buildStatusDisplay = document.getElementById('buildStatus');
      const createdAtDisplay = document.getElementById('createdAt');
      const updatedAtDisplay = document.getElementById('updatedAt');
      const imageRow = document.getElementById('imageRow');
      const imageUrlDisplay = document.getElementById('imageUrl');
      const refreshStatusButton = document.getElementById('refreshStatus');

      let currentBuildId = null;

      // 后端API地址
      const API_BASE_URL = 'http://localhost:3000/api';

      buildForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const repoUrl = document.getElementById('repoUrl').value;
        const branch = document.getElementById('branch').value;
        const imageName = document.getElementById('imageName').value;
        const imageTag = document.getElementById('imageTag').value;
        const registry = document.getElementById('registry').value;

        // 显示加载状态
        statusCard.classList.remove('hidden');
        statusOutput.className = 'status pending';
        statusOutput.textContent = '正在提交构建请求...';
        buildDetails.classList.add('hidden');

        // 发送构建请求
        fetch(`${API_BASE_URL}/build`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            repo_url: repoUrl,
            branch: branch,
            image_name: imageName,
            image_tag: imageTag,
            registry: registry
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              // 显示错误
              statusOutput.className = 'status error';
              statusOutput.textContent = `错误: ${data.error}`;
            } else {
              // 显示成功
              statusOutput.className = 'status success';
              statusOutput.textContent = `构建请求已提交! 构建ID: ${data.build_id}`;

              // 保存构建ID并获取状态
              currentBuildId = data.build_id;
              fetchBuildStatus(currentBuildId);
            }
          })
          .catch(error => {
            statusOutput.className = 'status error';
            statusOutput.textContent = `请求失败: ${error.message}`;
          });
      });

      // 刷新状态按钮
      refreshStatusButton.addEventListener('click', function () {
        if (currentBuildId) {
          fetchBuildStatus(currentBuildId);
        }
      });

      // 获取构建状态
      function fetchBuildStatus(buildId) {
        statusOutput.className = 'status pending';
        statusOutput.textContent = '正在获取构建状态...';

        fetch(`${API_BASE_URL}/build/${buildId}`)
          .then(response => response.json())
          .then(data => {
            // 显示构建详情
            buildDetails.classList.remove('hidden');
            buildIdDisplay.textContent = data.build_id;
            buildStatusDisplay.textContent = getStatusText(data.status);
            createdAtDisplay.textContent = formatDate(data.created_at);
            updatedAtDisplay.textContent = formatDate(data.updated_at);

            // 根据状态更新界面
            if (data.status === 'success') {
              statusOutput.className = 'status success';
              statusOutput.textContent = '构建成功!';

              if (data.image) {
                imageRow.classList.remove('hidden');
                imageUrlDisplay.textContent = data.image;
              }
            } else if (data.status === 'failed') {
              statusOutput.className = 'status error';
              statusOutput.textContent = '构建失败!';
            } else {
              statusOutput.className = 'status pending';
              statusOutput.textContent = '构建进行中...';

              // 每10秒自动刷新一次
              setTimeout(() => fetchBuildStatus(buildId), 10000);
            }
          })
          .catch(error => {
            statusOutput.className = 'status error';
            statusOutput.textContent = `获取状态失败: ${error.message}`;
          });
      }

      // 辅助函数
      function getStatusText(status) {
        switch (status) {
          case 'pending': return '进行中';
          case 'success': return '成功';
          case 'failed': return '失败';
          default: return status;
        }
      }

      function formatDate(dateStr) {
        return new Date(dateStr).toLocaleString('zh-CN');
      }
    });
  </script>
</body>

</html>